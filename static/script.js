function showModal(title, message){document.getElementById('modal-title').textContent=title;document.getElementById('modal-message').textContent=message;const modal=document.getElementById('modal-container');modal.classList.remove('hidden');modal.classList.add('flex');}
function closeModal(){const modal=document.getElementById('modal-container');modal.classList.add('hidden');modal.classList.remove('flex');}
function setupNavigation(){const navButtons=document.querySelectorAll('#sidebar button[data-target]');const panels=document.querySelectorAll('.dashboard-panel');const sidebar=document.getElementById('sidebar');const menuToggle=document.getElementById('menu-toggle');const modalClose=document.getElementById('modal-close');modalClose.addEventListener('click',closeModal);menuToggle.addEventListener('click',()=>sidebar.classList.toggle('-translate-x-full'));navButtons.forEach(btn=>{btn.addEventListener('click',function(){const target=this.getAttribute('data-target');navButtons.forEach(b=>b.classList.remove('mu-active-tab'));this.classList.add('mu-active-tab');panels.forEach(p=>p.classList.toggle('hidden',p.id!==target));if(window.innerWidth<768)sidebar.classList.add('-translate-x-full');});});}
function setupDetection(){const startBtn=document.getElementById('start-detection');const status=document.getElementById('detection-status');const textOutput=document.getElementById('text-output');const speechButton=document.getElementById('speech-button');const speechText=document.getElementById('speech-text');const videoStream=document.getElementById('video-stream');const videoPlaceholder=document.getElementById('video-placeholder');let detecting=false,predictionInterval,lastClass='',autoSpeak=false;startBtn.addEventListener('click',async()=>{if(!detecting){detecting=true;startBtn.textContent='Stop Detection';startBtn.classList.replace('bg-mu-primary','bg-red-600');status.textContent='Status: Detecting Signs...';try{await fetch('/start',{method:'POST'});videoStream.src='/video_feed';videoStream.classList.remove('hidden');videoPlaceholder.classList.add('hidden');predictionInterval=setInterval(async()=>{const res=await fetch('/predict');const data=await res.json();if(data.class!=='Waiting...'&&data.class!==lastClass){saveDetection(data.class,data.confidence);lastClass=data.class;if(autoSpeak&&'speechSynthesis'in window){const utterance=new SpeechSynthesisUtterance(data.class);speechSynthesis.speak(utterance);}}textOutput.innerHTML=`<span class="text-mu-accent font-bold">${data.class}</span><br><span class="text-gray-500 text-sm">Confidence: ${data.confidence}%</span>`;speechText.textContent=`Say: ${data.class}`;},500);showModal('Detection Started','ISL detection started.');}catch(e){showModal('Error','Failed to start detection: '+e.message);}}else{detecting=false;startBtn.textContent='Start Detection';startBtn.classList.replace('bg-red-600','bg-mu-primary');status.textContent='Status: Ready';clearInterval(predictionInterval);await fetch('/stop',{method:'POST'});videoStream.classList.add('hidden');videoPlaceholder.classList.remove('hidden');videoStream.src='';showModal('Detection Stopped','Detection has been halted.');}});speechButton.addEventListener('click',()=>{const textToSpeak=speechText.textContent.replace('Say: ','').trim();if(textToSpeak&&textToSpeak!=='Click to Speak Last Sentence'){if('speechSynthesis'in window){const utterance=new SpeechSynthesisUtterance(textToSpeak);speechSynthesis.speak(utterance);}autoSpeak=!autoSpeak;speechButton.innerHTML=`<span id="speech-text">${autoSpeak?'Auto-Speak: ON':'Click to Speak Last Sentence'}</span>`;showModal('Speech Output',autoSpeak?'Auto-speak enabled':`Speaking: "${textToSpeak}"`);}else{showModal('No Text to Speak','Start detection first.');}});}
function saveDetection(sign,confidence){const history=JSON.parse(localStorage.getItem('detectionHistory')||'[]');history.unshift({sign,confidence,timestamp:new Date().toISOString()});if(history.length>100)history.pop();localStorage.setItem('detectionHistory',JSON.stringify(history));updateMetrics();}
function updateMetrics(){const history=JSON.parse(localStorage.getItem('detectionHistory')||'[]');document.getElementById('total-detections').textContent=history.length;if(history.length>0){const avgConf=(history.reduce((sum,d)=>sum+d.confidence,0)/history.length).toFixed(1);document.getElementById('avg-confidence').textContent=avgConf+'%';const counts={};history.forEach(d=>counts[d.sign]=(counts[d.sign]||0)+1);const mostDetected=Object.keys(counts).reduce((a,b)=>counts[a]>counts[b]?a:b);document.getElementById('most-detected').textContent=mostDetected;}displayHistory();}
function displayHistory(){const history=JSON.parse(localStorage.getItem('detectionHistory')||'[]');const container=document.getElementById('detection-history');if(history.length===0){container.innerHTML='<p class="text-gray-500 text-center py-8">No detections yet</p>';return;}container.innerHTML=history.slice(0,50).map(d=>`<div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg"><div><span class="font-semibold text-gray-800">${d.sign}</span><span class="text-xs text-gray-500 ml-2">${new Date(d.timestamp).toLocaleString()}</span></div><span class="text-sm font-medium text-green-600">${d.confidence}%</span></div>`).join('');}
function setupResults(){document.getElementById('clear-history').addEventListener('click',()=>{if(confirm('Clear all detection history?')){localStorage.removeItem('detectionHistory');updateMetrics();showModal('History Cleared','All detection records removed.');}});updateMetrics();}
function setupDatasetUpload(){const uploadInput=document.getElementById('file-upload');const fileList=document.getElementById('file-list');const uploadButton=document.getElementById('upload-button');const uploadStatus=document.getElementById('upload-status');const folderId=document.getElementById('folder-id');let files=[];function updateList(){fileList.innerHTML=`<p class="font-medium text-gray-700">Selected Files (${files.length})</p>`;if(files.length>0){uploadButton.disabled=false;const ul=document.createElement('ul');ul.className='list-disc pl-5 space-y-1 text-sm text-gray-600';files.forEach(f=>{const li=document.createElement('li');li.textContent=`${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;ul.appendChild(li);});fileList.appendChild(ul);}else uploadButton.disabled=true;}uploadInput.addEventListener('change',e=>{files=Array.from(e.target.files);uploadStatus.textContent='';updateList();});uploadButton.addEventListener('click',async()=>{if(files.length===0)return;uploadButton.disabled=true;uploadButton.textContent='Uploading...';uploadStatus.textContent=`Uploading ${files.length} files to Google Drive...`;const formData=new FormData();files.forEach(f=>formData.append('files',f));formData.append('folder_id',folderId.value);try{const res=await fetch('/upload_dataset',{method:'POST',body:formData});const data=await res.json();if(data.error){uploadStatus.innerHTML=`<span class="text-red-600">❌ Error: ${data.error}</span>`;showModal('Upload Failed',data.error);}else{uploadStatus.innerHTML=`<span class="text-green-600">✅ Uploaded ${data.files.length} files to Google Drive!</span>`;showModal('Upload Complete',`${data.files.length} files uploaded successfully to Google Drive.`);uploadInput.value='';files=[];updateList();}}catch(e){uploadStatus.innerHTML=`<span class="text-red-600">❌ Error: ${e.message}</span>`;showModal('Upload Failed',e.message);}finally{uploadButton.textContent='Upload to Google Drive';uploadButton.disabled=false;}});}
window.onload=function(){setupNavigation();setupDetection();setupDatasetUpload();setupResults();};
